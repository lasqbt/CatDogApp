<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>Hello MUI</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<script type="text/javascript" src="../js/config.js"></script>

		<!--标准mui.css-->
		<link type="text/css" rel="stylesheet" href="../css/headerCss.css" />
		<link type="text/css" rel="stylesheet" href="../css/mui.css">
		<link type="text/css" rel="stylesheet" href="../css/showLoading.css" />
		<style>
			.mainDiv{
				background-image: url(../images/121234.png);
				top: 0;
				left: 0;
				overflow: hidden;
				zoom: 1; 
				background-color: #fff;
				background-repeat: no-repeat;
				background-size: cover;
				-webkit-background-size: cover;
				-o-background-size: cover;
				background-position: center 0;
			}
			
			.liCss{
				background-color:rgba(39,40,34,0.2);
				position: fixed;
				bottom: 0;
			}
			/*div隐藏滚动条 并且仍能滚动*/
			::-webkit-scrollbar{
				display: none;
			}
			
			.tdCss{
				width: 10%;
			}
			
			input{
				color: #929292;
				font-size: 0.8rem;
			}
			input::-webkit-input-placeholder{
			    color:#929292;
			}
			input::-moz-placeholder{   /* Mozilla Firefox 19+ */
			    color:#929292;
			}
			input:-moz-placeholder{    /* Mozilla Firefox 4 to 18 */
			    color:#929292;
			}
			input:-ms-input-placeholder{  /* Internet Explorer 10-11 */
			    color:#929292;
			}
			
			.detailCss{
				padding: 8px;
				font-size: 0.9rem;
			}
			
			.detailBtnCss{
				width: 95%;
				height: 40px;
				background-color: transparent;
				box-shadow: 0px 0px 3px #929292 inset;
				border-radius: 5px;
				border: 0;
				color: #929292;
			}

			.bottomSpan{
				border-radius:5px;
				color: red;
				background-color: #007AFF;
			}
			
			.mui-popup-input input{
				height: 150px;
			}
		</style>
	</head>
	<body style="margin:0px; padding:0px;">
		<div class="mainDiv" style="height:100%;width:100%;position:absolute;">				
			<header style="width: 100%;height: 4%;z-index: 99999999;">
				<span class="us_uer4" onclick="mui.back();"></span>
				<span class="mui-icon mui-icon-compose" id="remarkInfo" style="float: right;color: #929292;margin-right: 10px;"></span>
				<div class="fontCss" style="margin-left: 10%;">
					<span class="fontSpanCss">检修详情</span>
				</div>
				<div class="title"></div>
			</header>
			<div style="width: 95%;height: 80%;margin-top: 8px;margin-left: 2.5%;">
				<div style="width: 100%;height: 45%;box-shadow: 0px 0px 5px #929292 inset;border-radius: 5px;color: #929292;">
					<div style="width: 100%;text-align: center;height: 12%;font-size:18px;padding: 8px;">
						<img src="../images/d-55.png"  style="width: 10px;height: 10px;float: left;"/>
						<span style="color: blueviolet;">保养检修项目</span>
						<img src="../images/d-44.png"  style="width: 10px;height: 10px;float: right;"/>
					</div>
					<div style="width: 96%;overflow-y: auto;height: 76%;margin-left: 5px;" id="byProject">
						
					</div>
					<div style="width: 100%;text-align: center;height: 12%;font-size:18px;padding: 8px;">
						<img src="../images/d-11.png"  style="width: 10px;height: 10px;float: left;"/>
						<img src="../images/d-22.png"  style="width: 10px;height: 10px;float: right;"/>
					</div>
				</div>
				<div style="width: 100%;height: 45%;box-shadow: 0px 0px 5px #929292 inset;border-radius: 5px;color: #929292;margin-top: 8px;">
					<div style="width: 100%;text-align: center;height: 12%;font-size:18px;padding: 8px;">
						<img src="../images/d-55.png"  style="width: 10px;height: 10px;float: left;"/>
						<span style="color: blueviolet;">保养检修标准</span>
						<img src="../images/d-44.png"  style="width: 10px;height: 10px;float: right;"/>
					</div>
					<div style="width: 96%;overflow-y: auto;height: 76%;margin-left: 5px;" id="byStandard">
						
					</div>
					<div style="width: 100%;text-align: center;height: 12%;font-size:18px;padding: 8px;">
						<img src="../images/d-11.png"  style="width: 10px;height: 10px;float: left;"/>
						<img src="../images/d-22.png"  style="width: 10px;height: 10px;float: right;"/>
					</div>
				</div>
				<div style="width: 100%;height: 5%;margin-top: 8px;">
					<input type="text" value="" id="qianMingInfo" maxlength="15" placeholder="签名信息" style="width: 75%;height: 40px;background-color: transparent;box-shadow: 0px 0px 3px #929292 inset;border-radius: 5px;"> 
					<!-- width: 95%;
					height: 40px;
					background-color: transparent;
					box-shadow: 0px 0px 3px #929292 inset;
					border-radius: 5px;
					border: 0;
					color: #929292; -->
					<button type="button" id="saveName" class="mui-btn mui-btn-primary" style="background-color: transparent;box-shadow: 0px 0px 3px #929292 inset;color: border-radius: 5px;border: 0;color: #929292;height: 36px;width:23% ;margin-top: 2px;">
						保存签名
					</button>
				</div>
				<div style="width: 100%;height: 5%;text-align: center;margin-top: 17px;">
					<table style="width: 100%;">
						<tr>
							<td style="width: 25%;">
								<button type="button" id="uploadPic" class="mui-btn mui-btn-primary detailBtnCss">
									上传照片
								</button>
							</td>
							<td style="width: 25%;">
								<button type="button" id="lookPic" class="mui-btn mui-btn-primary detailBtnCss">
									查看照片
								</button>
							</td>
							<td style="width: 25%;">
								<button type="button" id="saveCheZhangName" class="mui-btn mui-btn-primary detailBtnCss">
									车长签名
								</button>
							</td>
							<td style="width: 25%;">
								<button type="button" id="submitAudit" class="mui-btn mui-btn-primary detailBtnCss">
									提交审核
								</button>
							</td>
						</tr>
					</table>
				</div>
			</div>
			<div class="liCss" style="width: 100%;overflow-x: auto;height: 50px;">
					<table style="width: 1000px;text-align: center;left: 0;">
						<tr id="repairProject" style="background-color: #502171;color: #929292;font-size: 0.8rem;height: 50px;">
						</tr>
					</table>
			</div>
		</div>
	</body>
	<script src="../js/jquery.min.js" type="text/javascript" ></script>
	<script src="../js/mui.min.js" type="text/javascript"></script>
	<script src="../js/mui.enterfocus.js" type="text/javascript"> </script>
	<script src="../js/app.js" type="text/javascript"></script>
	<script src="../js/common.js" type="text/javascript"> </script>
	<script src="../js/mui.pullToRefresh.js" type="text/javascript" charset="utf-8"></script>
	<script src="../js/commonUtils.js" type="text/javascript" charset="utf-8"></script>
	<script src="../js/showLoading.js" type="text/javascript"></script>

	<script>
		(function (mui) {
			mui.init(); 
			mui.plusReady(function(){
				//全局变量
				var needSignNum;
				var readlNeedSignNum;
				var userRoleInfo;
				var repairProjectId;
				var czNameInfo;
					  
				var projectIdArr = new Array();
				var self = plus.webview.currentWebview();
				var taskId = self.taskId;
				var taskStatus = self.taskStatus;
				console.log("编辑的任务ID=="+taskId);
				console.log("编辑的任务状态=="+taskStatus);
				//备注信息
				var remarkInfoCache = "";
				// 缓存数据
				var cacheData;
				//初始加载预加载数据
				var appSessionIdInfo = localStorage.getItem("appSessionIdInfo");
				var url = path1+'/trainApp/getRepairTaskTableInfo?appSessionIdInfo='+appSessionIdInfo;
				console.log("初始化日检或者定检详情信息数据=="+url);
				mui.showLoading("查询中,请稍后...","div");
				mui.ajax(url,{
					data:{id:taskId},
					dataType:'json',   
					type:'get',
					success:function(data){
						console.log("返回码是"+data.code);
						mui.hideLoading();
						if(data.code=='0'){
							mui.toast("数据加载成功");
							console.log(JSON.stringify(data));
							var mainListArr = data.mainList;
							cacheData = mainListArr;
							czNameInfo = data.czName;
							if(mainListArr!=null){
								var rHtml = "";
								var dHtml = "";
								var sHtml = "";
								var flag = true;
								//减一 是把备注去掉  备注放到页面右上角
								for(var v=0;v<mainListArr.length-1;v++){
									rHtml = rHtml + '<td class="tdCss" id="'+mainListArr[v].id+'">'+mainListArr[v].repairProject+'</td>';
									projectIdArr[v] = mainListArr[v].id;
									//加载保养项目和标准
									if(flag){
										var detailListArr = mainListArr[v].detailList;
										for(var b=0;b<detailListArr.length;b++){
										  dHtml = dHtml + '<span class="detailCss">'+(b+1)+'、'+detailListArr[b].repairProjectDetail+'</span><br>';
										  sHtml = sHtml + '<span class="detailCss">'+(b+1)+'、'+detailListArr[b].repairProjectStandard+'</span><br>';
										} 
										$("#qianMingInfo").val(mainListArr[0].auditUserName);
										flag = false;
									}
								}
								$("#repairProject").append(rHtml);
								$("#byProject").append(dHtml);
								$("#byStandard").append(sHtml); 
								
								//默认显示第一个检修项目
								$("#"+projectIdArr[0]).addClass("bottomSpan");
								repairProjectId = projectIdArr[0];
								
								readlNeedSignNum = data.readlNeedSignNum;
								needSignNum = data.needSignNum;
								userRoleInfo = data.userRole;
								remarkInfoCache = data.remarkInfo;
								
							}else{
								console.log(1111);
							}
							
						}else{
							mui.toast(data.msg);
						}
					},
					error:function(xhr,type,errorThrown){
						mui.hideLoading();
						if(type=='timeout'){
							mui.alert('链接服务器超时，请排查网络或者请求地址是否正确！');
						}else{
							mui.alert('请求失败');
						}
					}
				}); 
				
				//textarea 滚动条失效问题
				window.addEventListener('touchmove',function(e){
				  let target = e.target
				  if(target && target.tagName === 'TEXTAREA'){ 
					e.stopPropagation();
				  }
				},true);
				//textarea 自定义样式
				document.getElementById("remarkInfo").addEventListener('tap',function() {
					var a = mui.prompt('请输入备注信息','','备注',['取消','保存'],function(e){
						if(e.index==1){
							if(userRoleInfo != '1'){
								mui.toast("只有车长能操作");
								return;
							}
							var text = document.querySelector('.mui-popup-input textarea').value.trim();
							console.log(text);
							remarkInfoCache = text;
						}else{
							console.log('取消');
						}
					},'div');
					var lihh = document.querySelector('.mui-popup-input');
					lihh.innerHTML="<textarea placeholder='100个字符以内...' maxlength='100' cols='20' rows='5' style='height: 130px;border-radius: 10px;margin-top: 15px;font-size: 0.8rem;'>"+remarkInfoCache+"</textarea>";
				})
				
				//查看照片
				document.getElementById("lookPic").addEventListener('tap',function() {
					$("#lookPic").css("background-color","#007AFF");
					
					$("#uploadPic").css("background-color","transparent");
					$("#saveName").css("background-color","transparent");
					$("#submitAudit").css("background-color","transparent");
					$("#saveCheZhangName").css("background-color","transparent");
					
					var id = generateUUID()+"-dayRepairImgList";
					mui.openWindow({
						url: '../childPage/day-repair-img-list.html',
						id: id,
						show: {
							aniShow: 'pop-in'
						},
						styles: {
							popGesture: 'hide'
						},
						waiting: {
							autoShow: false
						},
						extras:{
							taskId:taskId
						},
						createNew:false
					});
				})
				//保存签名
				document.getElementById("saveName").addEventListener('tap',function() {
					$("#saveName").css("background-color","#007AFF");
					
					$("#lookPic").css("background-color","transparent");
					$("#uploadPic").css("background-color","transparent");
					$("#submitAudit").css("background-color","transparent");
					$("#saveCheZhangName").css("background-color","transparent");
					
					var qmInfo = $("#qianMingInfo").val();
					// 是否领导审批 0否1是
					var isLeaderAudit = "0";
					// 0领导  1车长  2普工  3技术员
					if(userRoleInfo == '0'){
						isLeaderAudit = "1";
					}
					if(qmInfo.trim().length==0){
						mui.toast("请输入签名信息");
						return;
					}
					if(taskStatus != '1'){
						mui.toast("只有待提交的任务才能此操作");
						return;
					}
					if(userRoleInfo == '1'){
						saveQianMingInfo(repairProjectId,qmInfo,isLeaderAudit,"1");
					}else{
						mui.toast("只有车长能操作");
						return;
					}
					
				})
				
				//保存签名信息
				function saveQianMingInfo(repairProjectConfigId,qmInfo,isLeaderAudit,operationStatus){
					var appSessionIdInfo = localStorage.getItem("appSessionIdInfo");
					var url = path1+'/task/auditRepairTask?appSessionIdInfo='+appSessionIdInfo;
					console.log("保存签名信息数据=="+url);
					mui.showLoading("保存中,请稍后...","div");
					mui.ajax(url,{
						data:{
								taskId:taskId,
								repairProjectConfigId: repairProjectConfigId,
								isLeaderAudit:isLeaderAudit,
								operationUser:qmInfo,
								remark1:remarkInfoCache,
								operationStatus:operationStatus
							},
						dataType:'json',   
						type:'POST',
						success:function(data){
							console.log("返回码是"+data.code);
							mui.hideLoading();
							mui.toast(data.msg);
						},
						error:function(xhr,type,errorThrown){
							mui.hideLoading();
							if(type=='timeout'){
								mui.alert('链接服务器超时，请排查网络或者请求地址是否正确！');
							}else{
								mui.alert('请求失败');
							}
						}
					}); 
				}
				
				//提交签名
				document.getElementById("submitAudit").addEventListener('tap',function() {
					$("#submitAudit").css("background-color","#007AFF");
					
					$("#lookPic").css("background-color","transparent");
					$("#saveName").css("background-color","transparent");
					$("#uploadPic").css("background-color","transparent");
					$("#saveCheZhangName").css("background-color","transparent");
					
					if(userRoleInfo == '1' && taskStatus == '1'){
						if(readlNeedSignNum === needSignNum){
							saveQianMingInfo(99999999,"",0,"4");
							
							//获取父页面main.html
							var list = plus.webview.currentWebview().opener();
							//自定义事件,事件名为getValueFromChild
							mui.fire(list,'createRepairAfterQueryInfo',null);
							// 返回父页面
							//mui.back();
							taskStatus="4";
						}else{
							mui.toast("尚有检修项目未签名，请全部签名完毕在提交审核");
						}
					}else{
						mui.toast("该任务已经处于审核中状态");
					}
					
				})
				
				//车长签名
				document.getElementById("saveCheZhangName").addEventListener('tap',function() {
					$("#saveCheZhangName").css("background-color","#007AFF");
					
					$("#lookPic").css("background-color","transparent");
					$("#saveName").css("background-color","transparent");
					$("#submitAudit").css("background-color","transparent");
					$("#uploadPic").css("background-color","transparent");
					
					var a = mui.prompt('请车长输入签名信息','','提示',['不签','签名'],function(e){
						if(e.index==1){
							if(taskStatus != '1'){
								mui.toast("只有待提交的任务才能此操作");
								return;
							}
							if(userRoleInfo != '1'){
								mui.toast("只有车长能操作");
								return;
							}
							var text = document.querySelector('.mui-popup-input textarea').value.trim();
							console.log(text);
							if(text == null || text.trim().length==0){
								mui.toast("签名信息不能为空");
							}else{
								saveQianMingInfo(99999998,text,0,"1");
								czNameInfo = text;
							}
						}else{
							console.log('不签');
						}
					},'div');
					var lihh = document.querySelector('.mui-popup-input');
					lihh.innerHTML="<textarea placeholder='10个字符以内...' maxlength='10' cols='10' rows='1' style='height: 44px;border-radius: 8px;margin-top: 15px;font-size: 0.8rem;'>"+czNameInfo+"</textarea>";
				})
				
				//上传照片
				document.getElementById("uploadPic").addEventListener('tap',function() {
					$("#uploadPic").css("background-color","#007AFF");
					
					$("#lookPic").css("background-color","transparent");
					$("#saveName").css("background-color","transparent");
					$("#submitAudit").css("background-color","transparent");
					$("#saveCheZhangName").css("background-color","transparent");
					if(taskStatus != '1'){
						mui.toast("只有待提交的任务才能此操作");
						return;
					}
					if(userRoleInfo != '1'){
						mui.toast("只有车长能操作");
						return;
					}
					
					var id = generateUUID()+"-dayRepairUploadingImg";
					mui.openWindow({
						url: '../childPage/day-repair-uploading-img.html',
						id: id,
						show: {
							aniShow: 'pop-in'
						},
						styles: {
							popGesture: 'hide'
						},
						waiting: {
							autoShow: false
						},
						extras:{
							obj:this,
							taskId:taskId
						},
						createNew:false
					});
				});
				
				$('#repairProject').on('tap', '.tdCss', function(event) {
					var clickId = this.id;
					for(var v=0;v<projectIdArr.length;v++){
						if(parseInt(clickId)  == parseInt(projectIdArr[v])){
							//增加样式
							$("#"+clickId).addClass("bottomSpan");
							//清除原有数据
							$("#byProject").empty();
							$("#byStandard").empty(); 
							//加载现有数据
							for(var m=0;m<cacheData.length;m++){
								if(clickId == cacheData[m].id){
									var detailListArr = cacheData[m].detailList;
									var dHtml = "";
									var sHtml = "";
									for(var b=0;b<detailListArr.length;b++){
									  dHtml = dHtml + '<span class="detailCss">'+(b+1)+'、'+detailListArr[b].repairProjectDetail+'</span><br>';
									  sHtml = sHtml + '<span class="detailCss">'+(b+1)+'、'+detailListArr[b].repairProjectStandard+'</span><br>';
									} 
									$("#byProject").append(dHtml);
									$("#byStandard").append(sHtml); 
									repairProjectId = clickId;
									$("#qianMingInfo").val(cacheData[m].auditUserName);
								}
							} 
							
						}else{
							//删除样式
							$("#"+projectIdArr[v]).removeClass("bottomSpan");
						}
					}
					
				})
			})
		})(mui);
	</script>
	
	
</html>